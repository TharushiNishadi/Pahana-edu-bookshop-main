<!DOCTYPE html>
<html>
<head>
    <title>Debug Password Change</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #1a1a1a; color: white; }
        .container { max-width: 800px; margin: 0 auto; background: #333; padding: 30px; border-radius: 10px; }
        .success { color: #4CAF50; font-weight: bold; }
        .error { color: #f44336; font-weight: bold; }
        .info { color: #2196F3; }
        button { padding: 12px 24px; margin: 10px 5px; background: #ffd700; color: #1a1a1a; border: none; border-radius: 8px; cursor: pointer; }
        .result { margin: 20px 0; padding: 15px; border-radius: 8px; background: #222; border: 1px solid #555; }
        .test-section { margin: 20px 0; padding: 20px; background: #444; border-radius: 8px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Debug Password Change Issue</h1>
        
        <div class="test-section">
            <h3>1. Test Backend Connection</h3>
            <button onclick="testBackend()">Test Backend</button>
            <div id="backendResult" class="result"></div>
        </div>

        <div class="test-section">
            <h3>2. Test Users Endpoint</h3>
            <button onclick="testUsersEndpoint()">Test /users</button>
            <div id="usersResult" class="result"></div>
        </div>

        <div class="test-section">
            <h3>3. Test Password Change Endpoint</h3>
            <button onclick="testPasswordEndpoint()">Test /user/verify-and-change-password</button>
            <div id="passwordResult" class="result"></div>
        </div>

        <div class="test-section">
            <h3>4. Test Actual Password Change</h3>
            <input type="text" id="testUserId" placeholder="User ID" value="admin001" style="width: 200px; padding: 8px; margin: 5px;">
            <input type="password" id="testCurrentPass" placeholder="Current Password" value="admin123" style="width: 200px; padding: 8px; margin: 5px;">
            <input type="password" id="testNewPass" placeholder="New Password" value="admin789" style="width: 200px; padding: 8px; margin: 5px;">
            <button onclick="testActualPasswordChange()">Test Password Change</button>
            <div id="actualResult" class="result"></div>
        </div>
    </div>

    <script>
        const BACKEND_URL = 'http://localhost:12345';

        async function testBackend() {
            const resultDiv = document.getElementById('backendResult');
            resultDiv.innerHTML = 'Testing backend connection...';
            
            try {
                const response = await fetch(`${BACKEND_URL}/`);
                if (response.ok) {
                    const text = await response.text();
                    resultDiv.innerHTML = `
                        <span class="success">‚úÖ Backend running on port 12345</span><br>
                        <strong>Response:</strong> ${text.substring(0, 100)}...
                    `;
                } else {
                    resultDiv.innerHTML = `<span class="error">‚ùå Backend error: ${response.status}</span>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<span class="error">‚ùå Connection failed: ${error.message}</span>`;
            }
        }

        async function testUsersEndpoint() {
            const resultDiv = document.getElementById('usersResult');
            resultDiv.innerHTML = 'Testing /users endpoint...';
            
            try {
                const response = await fetch(`${BACKEND_URL}/users`);
                if (response.ok) {
                    const users = await response.json();
                    resultDiv.innerHTML = `
                        <span class="success">‚úÖ /users endpoint working</span><br>
                        <strong>Found ${users.length} users</strong><br>
                        <strong>First user:</strong> ${JSON.stringify(users[0] || 'No users', null, 2)}
                    `;
                } else {
                    const errorText = await response.text();
                    resultDiv.innerHTML = `
                        <span class="error">‚ùå /users error: ${response.status}</span><br>
                        <strong>Response:</strong> ${errorText}
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `<span class="error">‚ùå /users failed: ${error.message}</span>`;
            }
        }

        async function testPasswordEndpoint() {
            const resultDiv = document.getElementById('passwordResult');
            resultDiv.innerHTML = 'Testing password change endpoint...';
            
            try {
                const response = await fetch(`${BACKEND_URL}/user/verify-and-change-password`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: 'test',
                        currentPassword: 'test',
                        newPassword: 'test'
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    resultDiv.innerHTML = `
                        <span class="success">‚úÖ Password endpoint responding</span><br>
                        <strong>Response:</strong> ${JSON.stringify(result, null, 2)}
                    `;
                } else {
                    const errorText = await response.text();
                    resultDiv.innerHTML = `
                        <span class="error">‚ùå Password endpoint error: ${response.status}</span><br>
                        <strong>Response:</strong> ${errorText}
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <span class="error">‚ùå Password endpoint failed: ${error.message}</span><br>
                    <strong>This suggests the endpoint might not be registered or there's a compilation error</strong>
                `;
            }
        }

        async function testActualPasswordChange() {
            const resultDiv = document.getElementById('actualResult');
            const userId = document.getElementById('testUserId').value;
            const currentPass = document.getElementById('testCurrentPass').value;
            const newPass = document.getElementById('testNewPass').value;
            
            if (!userId || !currentPass || !newPass) {
                resultDiv.innerHTML = '<span class="error">‚ùå Please fill all fields</span>';
                return;
            }
            
            resultDiv.innerHTML = 'Testing actual password change...';
            
            try {
                const response = await fetch(`${BACKEND_URL}/user/verify-and-change-password`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: userId,
                        currentPassword: currentPass,
                        newPassword: newPass
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.status === 'success') {
                        resultDiv.innerHTML = `
                            <span class="success">‚úÖ Password changed successfully!</span><br>
                            <strong>Message:</strong> ${result.message}<br>
                            <strong>New Password:</strong> ${newPass}
                        `;
                    } else {
                        resultDiv.innerHTML = `
                            <span class="error">‚ùå Password change failed</span><br>
                            <strong>Message:</strong> ${result.message || 'Unknown error'}
                        `;
                    }
                } else {
                    const errorText = await response.text();
                    resultDiv.innerHTML = `
                        <span class="error">‚ùå Password change error: ${response.status}</span><br>
                        <strong>Response:</strong> ${errorText}
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <span class="error">‚ùå Password change failed: ${error.message}</span><br>
                    <strong>Check if backend is running and compiled correctly</strong>
                `;
            }
        }

        // Auto-run backend test
        window.onload = function() {
            setTimeout(testBackend, 500);
        };
    </script>
</body>
</html>
